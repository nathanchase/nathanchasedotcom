---
---

<div id="watching">
  <h3 class="text-sm font-bold uppercase tracking-widest text-cream mb-6">Watching</h3>
  <div id="plex-history" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
    {Array.from({ length: 4 }).map(() => (
      <div class="rounded border border-muted/20 bg-warm-bg-light/30 animate-pulse">
        <div class="w-full aspect-[2/3] bg-warm-bg-light/50 rounded" />
      </div>
    ))}
  </div>
</div>

<script>
  async function loadPlexHistory() {
    const container = document.getElementById("plex-history");
    if (!container) return;

    try {
      const res = await fetch("/api/plex.json");
      if (!res.ok) throw new Error("Failed to fetch");
      const { items } = await res.json();

      if (!items || items.length === 0) {
        container.innerHTML = `<p class="text-cream-dark col-span-full text-sm">No recent watches found.</p>`;
        return;
      }

      container.innerHTML = items
        .map(
          (item: { title: string; subtitle?: string; type: string; thumb: string | null; viewedAt: number }) => `
        <div class="group block overflow-hidden rounded border border-muted/20 bg-warm-bg-light/30">
          ${item.thumb ? `<img src="${item.thumb}" alt="${item.title}" width="300" height="450" loading="lazy" class="w-full h-auto" />` : `<div class="w-full aspect-[2/3] bg-warm-bg-light flex items-center justify-center text-muted text-xs">${item.title}</div>`}
        </div>
      `
        )
        .join("");
    } catch {
      container.innerHTML = `<p class="text-cream-dark col-span-full text-sm">Could not load watch history.</p>`;
    }
  }

  const el = document.getElementById("watching")!;
  new IntersectionObserver(([e], obs) => { if (e.isIntersecting) { obs.disconnect(); loadPlexHistory(); } }, { rootMargin: "200px" }).observe(el);
</script>
